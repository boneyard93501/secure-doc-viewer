name: Deploy to Production

on:
  push:
    branches: [devops]

env:
  VM_HOST: ${{ vars.VM_HOST }}
  VM_USER: ${{ vars.VM_USER }}
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
  JWT_SECRET: ${{ secrets.JWT_SECRET }}
  RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      
      - name: Build release binary
        run: cargo build --release
      
      - name: Run tests (skip real_server_test)
        run: cargo test --release --lib && cargo test --release --test api_test --test blocklist_test --test db_test --test db_module_test --test http_test --test integration_test
      
      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: docsend-binary
          path: target/release/docsend
          
      - name: Upload admin binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: docsend-admin-binary
          path: target/release/docsend-admin
          
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ vars.VM_HOST }} >> ~/.ssh/known_hosts
      
      - name: Install Ansible
        run: |
          sudo apt update
          sudo apt install -y ansible
      
      - name: Download binary artifact
        uses: actions/download-artifact@v4
        with:
          name: docsend-binary
          path: ./artifact
      
      - name: Download admin binary artifact
        uses: actions/download-artifact@v4
        with:
          name: docsend-admin-binary
          path: ./artifact
      
      - name: Make binaries executable
        run: chmod +x ./artifact/docsend ./artifact/docsend-admin
      
      - name: Run Ansible deployment
        run: |
          cd ansible
          ansible-playbook -i inventory.yml deploy.yml \
            -e "ansible_host=$VM_HOST" \
            -e "ansible_user=$VM_USER" \
            -e "ansible_ssh_private_key_file=~/.ssh/id_rsa" \
            -e "docsend_binary_path=../artifact/docsend" \
            -e "docsend_admin_binary_path=../artifact/docsend-admin" \
            -e "db_password=$DB_PASSWORD" \
            -e "jwt_secret=$JWT_SECRET" \
            -e "resend_api_key=$RESEND_API_KEY" \
            -e "admin_email=$ADMIN_EMAIL" \
            -e "admin_password=$ADMIN_PASSWORD"
        env:
          ANSIBLE_HOST_KEY_CHECKING: False
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}