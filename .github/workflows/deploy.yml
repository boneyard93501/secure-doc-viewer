name: Deploy to Production

on:
  push:
    branches: [devops]

env:
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
  JWT_SECRET: ${{ secrets.JWT_SECRET }}
  RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      
      - name: Build release binary
        run: cargo build --release
      
      - name: Run tests (skip real_server_test)
        run: cargo test --release --lib && cargo test --release --test api_test --test blocklist_test --test db_test --test db_module_test --test http_test --test integration_test
      
      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: docsend-binary
          path: target/release/docsend
          
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts
      
      - name: Install Ansible
        run: |
          sudo apt update
          sudo apt install -y ansible
      
      - name: Download binary artifact
        uses: actions/download-artifact@v4
        with:
          name: docsend-binary
          path: ./artifact
      
      - name: Make binary executable
        run: chmod +x ./artifact/docsend
      
      - name: Run Ansible deployment
        run: |
          cd ansible
          ansible-playbook -i inventory.yml deploy.yml \
            -e "docsend_binary_path=../artifact/docsend" \
            -e "db_password=$DB_PASSWORD" \
            -e "jwt_secret=$JWT_SECRET" \
            -e "resend_api_key=$RESEND_API_KEY"
        env:
          ANSIBLE_HOST_KEY_CHECKING: False