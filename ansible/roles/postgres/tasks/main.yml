---
- name: Update apt cache and upgrade packages
  apt:
    upgrade: dist
    update_cache: yes
    cache_valid_time: 3600

- name: Install Docker
  apt:
    name:
      - docker.io
      - python3-docker
    state: present
    update_cache: yes

- name: Start Docker with systemctl
  shell: |
    systemctl daemon-reload
    systemctl enable docker
    systemctl start docker

- name: Verify Docker running
  shell: systemctl is-active docker
  register: docker_status
  until: docker_status.stdout == "active"
  retries: 5
  delay: 2

- name: Add user to docker group
  user:
    name: "{{ ansible_user }}"
    groups: docker
    append: yes

- name: Create PostgreSQL container
  docker_container:
    name: docsend_postgres
    image: postgres:16-alpine
    state: started
    restart_policy: always
    published_ports:
      - "{{ db_port }}:5432"
    env:
      POSTGRES_USER: "{{ db_user }}"
      POSTGRES_PASSWORD: "{{ db_password }}"
      POSTGRES_DB: "{{ db_name }}"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U {{ db_user }} -d {{ db_name }}"]
      interval: 5s
      timeout: 5s
      retries: 5

- name: Wait for PostgreSQL
  command: docker exec docsend_postgres pg_isready -U {{ db_user }} -d {{ db_name }}
  register: pg_ready
  until: pg_ready.rc == 0
  retries: 10
  delay: 3
  changed_when: false
